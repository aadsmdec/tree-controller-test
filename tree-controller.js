var Montage=require("montage/core/core").Montage;exports.TreeNodeController=Montage.specialize({constructor:{value:function(e,t,n,i,o){var a,s,r=[];this._controller=e,e._nodeCount++,this.parent=t,this.depth=i,this.index=o||0,this._expanded=e.expandedPath&&void 0!==n[e.expandedPath]?n[e.expandedPath]:e.initiallyExpanded||!1,this._expanded&&e._expandedNodeCount++,a="content."+(e.childrenPath||"children"),this.content=n,this._ignoreChildrenContentChange=!0,this._cancelChildrenContentChangeListener=this.addRangeAtPathChangeListener(a,this,"handleChildrenContentChange"),this._ignoreChildrenContentChange=!1,s=this.getPath(a),this.children=s?this._createChildren(s,r):[],this.iterations=r}},content:{value:null},_expanded:{value:!1},expanded:{get:function(){return this._expanded},set:function(e){e!==this._expanded&&(this._expanded=e,e?this._expand():this._collapse(),this._controller.handleIterationsChange())}},_createChildren:{value:function(e,t){return e.map(function(e,n){var i=new this.constructor(this._controller,this,e,this.depth+1,n);return t.push(i),i.expanded&&t.swap(t.length,0,i.iterations),i},this)}},_destroy:{value:function(){this._controller._nodeCount--,this.expanded&&this._controller._expandedNodeCount--,this._controller=null,this.parent=null,this._cancelChildrenContentChangeListener(),this.content=null;for(var e=0;this.children.length>e;e++)this.children[e]._destroy();this.children=null}},_collapse:{value:function(){this._controller._expandedNodeCount--,this._removeIterationsFromParent(this.iterations.length,this)}},_expand:{value:function(){this._controller._expandedNodeCount++,this._addIterationsToParent(this.iterations,this)}},_addIterationsToParent:{value:function(e,t){var n,i;this.parent?this.parent.expanded&&(n=this.parent.iterations,i=n.indexOf(t)+1,n.swap(i,0,e),this.parent._addIterationsToParent(e,t)):this._addIterationsToController(e,t)}},_removeIterationsFromParent:{value:function(e,t){var n,i;this.parent?this.parent.expanded&&(n=this.parent.iterations,i=n.indexOf(t)+1,n.splice(i,e),this.parent._removeIterationsFromParent(e,t)):this._removeIterationsFromController(e,t)}},_addIterationsToController:{value:function(e,t){var n,i=this._controller.iterations;n=i.indexOf(t)+1,i.swap(n,0,e)}},_removeIterationsFromController:{value:function(e,t){var n,i=this._controller.iterations;n=i.indexOf(t)+1,i.splice(n,e)}},findNodeByContent:{value:function(e,t){if(t=t||Object.is,t(this.content,e))return this;for(var n,i=0;this.children.length>i&&!(n=this.children[i].findNodeByContent(e,t));i++);return n}},preOrderWalk:{value:function(e){e(this);for(var t=0;this.children.length>t;t++)this.children[t].preOrderWalk(e)}},postOrderWalk:{value:function(e){for(var t=0;this.children.length>t;t++)this.children[t].postOrderWalk(e);e(this)}},_updateChildrenIndexes:{value:function(e){for(var t=this.children,n=e;t.length>n;n++)t[n].index=n}},handleChildrenContentChange:{value:function(e,t,n){var i,o,a,s,r,l,h,d,c=this.children,p=this.iterations;if(!this._ignoreChildrenContentChange){if(t.length>0){s=c[n],i=p.indexOf(s),r=c[n+t.length],o=p.indexOf(r),0>i&&(i=0),0>o&&(o=p.length),a=o-i,h=this.children.splice(n,t.length),this._updateChildrenIndexes(n),p.splice(i,a),this._removeIterationsFromParent(a,p[i-1]||this);for(var u=0;h.length>u;u++)h[u]._destroy()}e.length>0&&(r=c[n],d=[],l=this._createChildren(e,d),this.children.swap(n,0,l),this._updateChildrenIndexes(n+e.length),i=r?p.indexOf(r):p.length,this.iterations.swap(i,0,d),this._addIterationsToParent(d,p[i-1]||this)),this._controller.handleIterationsChange()}}}}),exports.TreeController=Montage.specialize({constructor:{value:function(e,t,n,i){this.super(),this.childrenPath=t,this.initiallyExpanded=n,this.expandedPath=i,this.content=e}},childrenPath:{value:null},expandedPath:{value:null},iterations:{value:null},_nodeCount:{value:0},_expandedNodeCount:{value:0},_content:{value:null},content:{get:function(){return this._content},set:function(e){if(e!==this._content){if(e){this.root=new this.NodeController(this,null,e,0);var t=[this.root];this.root.expanded&&t.swap(1,0,this.root.iterations),this.iterations=t}else this.root&&(this.root._destroy(),this.root=null,this.iterations=null);this._content=e,this.handleIterationsChange()}}},_allExpanded:{value:null},allExpanded:{get:function(){return this._allExpanded},set:function(e){e!==this._allExpanded&&(e&&this.preOrderWalk(function(e){e.expanded=!0}),this._allExpanded=e)}},_noneExpanded:{value:null},noneExpanded:{get:function(){return this._noneExpanded},set:function(e){e!==this._noneExpanded&&(e&&(this.preOrderWalk(function(e){e._expanded=!1,e.iterations=e.children.slice(0)}),this._expandedNodeCount=0,this.iterations.splice(1,this.iterations.length-1),this.handleIterationsChange()),this._noneExpanded=e)}},_changeOwnProperty:{value:function(e,t){t!==this[e]&&(this["_"+e]=t,this.dispatchOwnPropertyChange(e,t))}},handleIterationsChange:{value:function(){this.iterations&&this._changeOwnProperty("allExpanded",this.iterations.length===this._nodeCount),this._changeOwnProperty("noneExpanded",0===this._expandedNodeCount)}},NodeController:{value:exports.TreeNodeController},findNodeByContent:{value:function(e,t){return this.root?this.root.findNodeByContent(e,t):null}},preOrderWalk:{value:function(e){this.root&&this.root.preOrderWalk(e)}},postOrderWalk:{value:function(e){this.root&&this.root.postOrderWalk(e)}}});